import argparse
import base64
import io
import os
import time
import subprocess
from typing import Optional, List

from playwright.sync_api import sync_playwright, TimeoutError as PWTimeout
from PyPDF2 import PdfReader, PdfWriter

DETAIL_PATH_KEY = "/ls/vsa/servlet/SendungBearbeitung"
SUMATRA_PATH = r"C:\Users\tamolnar\Documents\SumatraPDF-3.5.2-64\SumatraPDF.exe"

def log(m): print(f"[phase2] {m}", flush=True)

# ---------- Context / page helpers ----------

def get_current_order_page(context) -> Optional[object]:
    for p in context.pages:
        if not p.is_closed() and DETAIL_PATH_KEY in (p.url or ""):
            return p
    return None

def ensure_detail_ready(page):
    page.bring_to_front()
    page.locator("#elmtKopf\\.Geschaeftsfall").wait_for(state="attached", timeout=15000)

def get_dn_number(page) -> str:
    try:
        return page.locator("input[name='SendungNrDfue']").input_value().strip()
    except:
        try:
            return page.locator("div.input-disabled i").inner_text().strip()
        except:
            return "document"

# ---------- Forwarder detection ----------

def detect_forwarder(page) -> str:
    legs_tbl = page.locator("#TableLegs")
    if legs_tbl.count() > 0:
        text = legs_tbl.inner_text().lower()
    else:
        rows = page.locator("tr.table-list-row--border")
        text = "\n".join(rows.all_text_contents()).lower()

    if "fedex" in text: return "FEDEX"
    if "dsv" in text and "air" in text: return "DSV-AIR"
    if "dsv" in text and "road" in text: return "DSV-ROAD"
    if "dhl express" in text: return "DHL-EXP"
    if "maersk" in text: return "MAERSK"
    if "tromp" in text: return "TROMP"
    if any(x in text for x in ["boogard", "boogaard", "vdb"]): return "VDB"
    if any(x in text for x in ["kuehne", "kühne", "kuehne nagel", "kuehne+nagel", "knn"]): return "KNN"
    if "dhl" in text: return "DGF"
    return "UNKNOWN"

# ---------- Document select + print button ----------

def select_document(page, value: str):
    sel = page.locator("#elmtLeg\\.DokumenteDokumente")
    sel.wait_for(state="visible", timeout=10000)
    sel.select_option(value=value)
    log(f"Selected document value={value}")

def click_leg_print_button(page):
    btn = page.locator("#aElmtBtnLegPrint")
    if btn.count():
        btn.first.click()
        log("Clicked Leg Print button.")
        return
    page.evaluate("() => (typeof clickGuiButton==='function') && clickGuiButton('BtnLegPrint')")
    log("Fallback clickGuiButton('BtnLegPrint').")

# ---------- Popup handling ----------

def wait_for_first_popup(context, page):
    try:
        return page.wait_for_event("popup", timeout=8000)
    except PWTimeout:
        before = set(context.pages)
        for _ in range(20):
            time.sleep(0.15)
            after = set(context.pages)
            new_pages = list(after - before)
            if new_pages:
                return new_pages[0]
        raise RuntimeError("No popup detected.")

def click_do_print_in_popupA(popup):
    popup.bring_to_front()
    try:
        if popup.evaluate("() => typeof doPrint === 'function'"):
            popup.evaluate("() => doPrint()")
            log("Called doPrint().")
            return True
    except:
        pass
    try:
        loc = popup.locator("a[onclick*='doPrint'], a.locale-icon-print").first
        if loc.count():
            loc.click()
            log("Clicked toolbar Print.")
            return True
    except:
        pass
    return False

def wait_for_label_view_after_do_print(context, popupA):
    try:
        return popupA.wait_for_event("popup", timeout=5000)
    except:
        return popupA

# ---------- Printing via Sumatra ----------

def print_pdf_windows(pdf_path, copies=1):
    for _ in range(copies):
        subprocess.run([
            SUMATRA_PATH,
            "-print-to-default",
            "-print-settings", "noscale,simplex",
            pdf_path
        ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        time.sleep(0.3)
    log(f"Sent {copies} copies of {os.path.basename(pdf_path)} to printer.")

def save_pdf_bytes(name: str, pdf_bytes: bytes) -> str:
    tmp_dir = os.path.join(os.getcwd(), "_alpega_tmp")
    os.makedirs(tmp_dir, exist_ok=True)
    path = os.path.join(tmp_dir, f"{name}.pdf")
    with open(path, "wb") as f:
        f.write(pdf_bytes)
    return path

# ---------- PDF acquisition ----------

def fedex_try_download_via_doPrint(popupA) -> Optional[bytes]:
    try:
        with popupA.expect_download(timeout=10000) as dl_info:
            popupA.evaluate("() => { if (typeof doPrint==='function') doPrint(); }")
        dl = dl_info.value
        tmp_path = os.path.join(os.getcwd(), "_alpega_tmp", dl.suggested_filename)
        os.makedirs(os.path.dirname(tmp_path), exist_ok=True)
        dl.save_as(tmp_path)
        with open(tmp_path, "rb") as f:
            return f.read()
    except Exception as e:
        log(f"Download failed: {e}")
        return None

def split_pdf_ranges(pdf_bytes: bytes, ranges: List[List[int]]) -> List[Optional[bytes]]:
    outs = []
    reader = PdfReader(io.BytesIO(pdf_bytes))
    total = len(reader.pages)
    for start, end in ranges:
        s = max(1, start); e = min(total, end)
        if s > e:
            outs.append(None)
            continue
        writer = PdfWriter()
        for p in range(s-1, e):
            writer.add_page(reader.pages[p])
        bio = io.BytesIO()
        writer.write(bio)
        outs.append(bio.getvalue())
    return outs

# ---------- FedEx page-range printing ----------

def fedex_print_with_ranges(context, pdf_bytes: bytes, dn_number: str):
    reader = PdfReader(io.BytesIO(pdf_bytes))
    total = len(reader.pages)

    # pages 1–2 twice
    if total >= 1:
        part12 = split_pdf_ranges(pdf_bytes, [[1, min(2, total)]])[0]
        if part12:
            path = save_pdf_bytes(f"{dn_number}_pages1-2", part12)
            print_pdf_windows(path, copies=2)

    # pages 5..end once
    if total >= 5:
        part5n = split_pdf_ranges(pdf_bytes, [[5, total]])[0]
        if part5n:
            path = save_pdf_bytes(f"{dn_number}_pages5-end", part5n)
            print_pdf_windows(path, copies=1)

# ---------- Main ----------

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--cdp", default="http://localhost:9222")
    args = ap.parse_args()

    with sync_playwright() as p:
        browser = p.chromium.connect_over_cdp(args.cdp)
        context = browser.contexts[0]
        page = get_current_order_page(context)
        if not page:
            raise RuntimeError("No open order detail tab found.")

        dn_number = get_dn_number(page)
        log(f"Using current tab: {page.url}")
        ensure_detail_ready(page)
        fwd = detect_forwarder(page)
        log(f"Forwarder: {fwd}")

        def run_doc(value: str, copies: int, fedex_mode=False):
            select_document(page, value)
            click_leg_print_button(page)
            popupA = wait_for_first_popup(context, page)
            if not click_do_print_in_popupA(popupA):
                return
            label_page = wait_for_label_view_after_do_print(context, popupA)

            if fedex_mode:
                pdf_bytes = fedex_try_download_via_doPrint(popupA)
                if pdf_bytes:
                    fedex_print_with_ranges(context, pdf_bytes, dn_number)
            else:
                pdf_bytes = fedex_try_download_via_doPrint(popupA)
                if pdf_bytes:
                    path = save_pdf_bytes(dn_number, pdf_bytes)
                    print_pdf_windows(path, copies=copies)

        if fwd == "FEDEX":
            run_doc("LABELXXQQXXlabelFedExWeb", copies=1, fedex_mode=True)
        elif fwd == "DSV-AIR":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "DSV-ROAD":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "DGF":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "DHL-EXP":
            run_doc("LABELXXQQXXLabelDHL_Web", copies=1)
        elif fwd == "KNN":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "MAERSK":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "TROMP":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        elif fwd == "VDB":
            run_doc("LABELXXQQXXLabelCarrier", copies=1)
        else:
            log("Unknown forwarder. No documents printed.")

        log("Done.")

if __name__ == "__main__":
    main()